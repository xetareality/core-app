<script>
function addressExplorer() {
    return {
        resource: 'pools',
        resourceFilter: null,
        transfersFilter: 'incoming',
        claimsFilter: 'held',
        allowancesFilter: 'spendable',
        transfers: [],
        transfersOutgoing: [],
        transfersIncoming: [],
        transactions: [],
        tokens: [],
        pools: [],
        claims: [],
        claimsIssued: [],
        claimsHeld: [],
        pools: [],
        allowances: [],
        allowancesGranted: [],
        allowancesSpendable: [],
        balances: [],
        existing: [],
        address: gup('address'),
        depleted: {},
        methods: {
            'transfersIncoming': Xeta.transfer.scanToCreated,
            'transfersOutgoing': Xeta.transfer.scanFromCreated,
            'transactions': Xeta.transaction.scanSenderCreated,
            'tokens': Xeta.token.scanOwnerCreated,
            'pools': Xeta.pool.scanCreatorCreated,
            'claimsHeld': Xeta.claim.scanHolderCreated,
            'claimsIssued': Xeta.claim.scanIssuerCreated,
            'balances': Xeta.balance.scanAddressAmount,
            'allowancesGranted': Xeta.allowance.scanAddressCreated,
            'allowancesSpendable': Xeta.allowance.scanSpenderCreated,
        },
        inputs: {
            'transfersIncoming': 'to',
            'transfersOutgoing': 'from',
            'transactions': 'sender',
            'tokens': 'owner',
            'pools': 'creator',
            'claimsHeld': 'holder',
            'claimsIssued': 'issuer',
            'balances': 'address',
            'allowancesGranted': 'address',
            'allowancesSpendable': 'spender',
        },
        init() {
            var self = this
            document.addEventListener('resourceLoaded', function (e) {
                var address = Alpine.store('address')
                try { if (address.token.meta.default) self.resource = address.token.meta.default } catch (e) {}
                self.change(self.resource)
            })
        },
        change(resource) {
            this.resource = resource
            var filter = this[resource+'Filter']
            this.resourceFilter = resource+(filter ? filter[0].toUpperCase()+filter.slice(1) : '')
            this.load(resource)
        },
        load(resource) {
            this[resource] = this[this.resourceFilter]
            if (this.depleted[this.resourceFilter]) return
            var last = this[this.resourceFilter].length ? this[this.resourceFilter].slice(-1)[0] : {}
            var self = this

            this.methods[this.resourceFilter]({...last, ...{[this.inputs[this.resourceFilter]]: this.address}}, {preview: true}).then(function(data) {
                if (!data.length) self.depleted[self.resourceFilter] = true
                self[self.resourceFilter] = self[self.resourceFilter].concat(data)
                if (resource != self.resourceFilter) self[resource] = self[self.resourceFilter]
            }).catch(function(e) {})
        },
    }
}
</script>

<div x-data="addressExplorer">
    <div class="bg-black rounded-2xl px-2 pt-2 mb-2 text-sm font-light text-gray-200 section">
        <div class="flex flex-wrap">
            <template x-for="type in ['transfers', 'balances', 'tokens', 'transactions', 'pools', 'claims', 'allowances']">
                <div @click="change(type)" :class="{'border-pink-700': resource == type}" class="inline border-b-4 border-gray-900 hover:border-pink-700 px-4 py-2 cursor-pointer capitalize" x-text="type"></div>
            </template>
        </div>
    </div>

    <div class="bg-black rounded-2xl py-4 mb-4 lg:mb-12">
        <div class="flex justify-between items-center px-6">
            <p class="text-lg py-2 text-gray-100 capitalize" x-text="resource"></p>
            <div x-cloak x-show="['transfers', 'claims', 'allowances'].includes(resource)" x-data="{active: false}" class="relative text-white text-sm">
                <span @click="active = !active" class="select-none cursor-pointer px-3 py-2 rounded-2xl text-gray-200 hover:bg-gray-800 bg-gray-900 capitalize" x-text="$data[resource+'Filter']"></span>
                <div x-cloak x-show="active" @click.away="active = false" class="absolute right-0 origin-top-right mt-2 w-32 shadow-xl rounded z-50">
                    <ul class="list-none bg-gray-900 px-2 py-2 rounded-2xl">
                        <template x-for="[key, type] in Object.entries({incoming: 'transfers', outgoing: 'transfers', issued: 'claims', held: 'claims', granted: 'allowances', spendable: 'allowances'})">
                            <li x-cloak x-show="type == resource" @click="this[type+'Filter'] = key, change(type), active = false" x-text="key" class="cursor-pointer py-1 rounded-2xl text-gray-200 hover:bg-gray-800 text-center capitalize"></li>
                        </template>
                    </ul>
                </div>
            </div>
        </div>

        <div x-cloak x-show="resource == 'transfers'"><table class="w-full table-fixed font-light text-sm">
    <thead>
        <tr class="text-gray-400">
            <th class="truncate py-2 pr-4 text-left uppercase md:w-2/12 pl-6">Hash</th>
            <th class="truncate py-2 pr-4 text-left uppercase md:w-2/12">Created</th>
            <th class="truncate py-2 pr-4 text-left uppercase md:w-2/12">Amount</th>
            <th class="truncate py-2 pr-4 text-left uppercase md:w-3/12">From</th>
            <th class="truncate py-2 pr-6 text-left uppercase md:w-3/12">To</th>
        </tr>
    </thead>
    <tbody>
        <template x-for="(transfer, i) in transfers">
            <tr :class="{'bg-gray-900 bg-opacity-50': i % 2 == 0}" class="hover:bg-gray-900 text-white">
                <td class="truncate pr-4 py-2 pl-6" x-html="Wrap.transfer(transfer.hash)"></td>
                <td class="truncate pr-4 py-2" x-text="formatTime(transfer.created)"></td>
                <td class="truncate pr-4 py-2" x-html="Wrap.amount(transfer.amount, transfer.token, transfer.tokenPreview)"></td>
                <td class="truncate pr-4 py-2" x-html="Wrap.address(transfer.from)"></td>
                <td class="truncate pr-6 py-2" x-html="Wrap.address(transfer.to)"></td>
            </tr>
        </template>
    </tbody>
</table>

<!-- <table class="w-full table-fixed font-light text-sm">
    <thead>
        <tr class="text-gray-400">
            <th class="truncate py-2 pr-4 text-left uppercase w-1/3 md:w-2/12 pl-6">Amount</th>
            <th class="truncate py-2 pr-4 text-left uppercase w-1/3 md:w-3/12">From</th>
            <th class="truncate py-2 pr-6 md:pr-4 text-left uppercase w-1/3 md:w-3/12">To</th>
            <th class="truncate py-2 pr-4 text-left uppercase w.0 md:w-2/12 hidden md:table-cell">Created</th>
            <th class="truncate py-2 pr-6 text-left uppercase w-0 md:w-2/12 hidden md:table-cell">Hash</th>
        </tr>
    </thead>
    <tbody>
        <template x-for="(transfer, i) in transfers">
            <tr :class="{'bg-gray-900 bg-opacity-50': i % 2 == 0}" class="hover:bg-gray-900 text-white">
                <td class="truncate pr-4 py-2 pl-6" x-html="Wrap.amount(transfer.amount, transfer.token, transfer.tokenPreview)"></td>
                <td class="truncate pr-4 py-2" x-html="Wrap.address(transfer.from)"></td>
                <td class="truncate pr-6 md:pr-4 py-2" x-html="Wrap.address(transfer.to)"></td>
                <td class="truncate pr-4 py-2 hidden md:table-cell" x-text="formatTime(transfer.created)"></td>
                <td class="truncate pr-6 py-2 hidden md:table-cell" x-html="Wrap.transfer(transfer.hash)"></td>
            </tr>
        </template>
    </tbody>
</table> --></div>
        <div x-cloak x-show="resource == 'balances'"><!-- <table class="w-full table-fixed font-light text-sm">
    <thead>
        <tr class="text-gray-400">
            <th class="truncate py-2 pr-4 text-left uppercase w-4/12 pl-6">Amount</th>
            <th class="truncate py-2 pr-4 text-left uppercase w-4/12">Token</th>
            <th class="truncate py-2 pr-6 text-left uppercase w-4/12 hidden md:table-cell">Hash</th>
        </tr>
    </thead>
    <tbody>
        <template x-for="(balance, i) in balances">
            <tr :class="{'bg-gray-900 bg-opacity-50': i % 2 == 0}" class="hover:bg-gray-900 text-white">
                <td class="truncate pr-4 py-2 pl-6" x-html="Wrap.amount(balance.amount, balance.token, balance.tokenPreview)"></td>
                <td class="truncate pr-4 py-2" x-html="Wrap.token(balance.token)"></td>
                <td class="truncate pr-6 py-2 hidden md:table-cell" x-html="balance.hash"></td>
            </tr>
        </template>
    </tbody>
</table> -->

<!-- <table class="w-full table-fixed font-light text-sm">
    <thead>
        <tr class="text-gray-400">
            <th class="truncate py-2 pr-4 text-left uppercase w-5/12 pl-6">Token</th>
            <th class="truncate py-2 pr-4 text-left uppercase w-5/12 hidden md:table-cell">Hash</th>
            <th class="truncate py-2 pr-6 text-left uppercase w-2/12">Amount</th>
        </tr>
    </thead>
    <tbody>
        <template x-for="(balance, i) in balances">
            <tr :class="{'bg-gray-900 bg-opacity-50': i % 2 == 0}" class="hover:bg-gray-900 text-white">
                <td class="truncate pr-4 py-2 pl-6" x-html="Wrap.token(balance.token)"></td>
                <td class="truncate pr-4 py-2 hidden md:table-cell" x-html="balance.hash"></td>
                <td class="truncate pr-6 py-2" x-html="Wrap.amount(balance.amount, balance.token, balance.tokenPreview)"></td>
            </tr>
        </template>
    </tbody>
</table> -->

<!-- <table class="w-full table-fixed font-light text-sm">
    <thead>
        <tr class="text-gray-400">
            <th class="truncate py-2 pr-4 text-left uppercase w-0 w-5/12 pl-6 hidden md:table-cell">Hash</th>
            <th class="truncate py-2 pr-4 text-left uppercase w-2/3 md:w-5/12 pl-6 md:pl-0">Token</th>
            <th class="truncate py-2 pr-6 text-left uppercase w-1/3 md:w-2/12">Amount</th>
        </tr>
    </thead>
    <tbody>
        <template x-for="(balance, i) in balances">
            <tr :class="{'bg-gray-900 bg-opacity-50': i % 2 == 0}" class="hover:bg-gray-900 text-white">
                <td class="truncate pr-4 py-2 pl-6 hidden md:table-cell" x-html="balance.hash"></td>
                <td class="truncate pr-4 py-2 pl-6 md:pl-0" x-html="Wrap.token(balance.token)"></td>
                <td class="truncate pr-6 py-2" x-html="Wrap.amount(balance.amount, balance.token, balance.tokenPreview)"></td>
            </tr>
        </template>
    </tbody>
</table> -->

<table class="w-full table-fixed font-light text-sm">
    <thead>
        <tr class="text-gray-400">
            <th class="truncate py-2 pr-4 text-left uppercase w-0 md:w-5/12 pl-6 hidden md:table-cell">Hash</th>
            <th class="truncate py-2 pr-4 text-left uppercase w-1/3 md:w-3/12 pl-6 md:pl-0">Amount</th>
            <th class="truncate py-2 pr-6 text-left uppercase w-2/3 md:w-4/12">Token</th>
        </tr>
    </thead>
    <tbody>
        <template x-for="(balance, i) in balances">
            <tr :class="{'bg-gray-900 bg-opacity-50': i % 2 == 0}" class="hover:bg-gray-900 text-white">
                <td class="truncate pr-4 py-2 pl-6 hidden md:table-cell" x-html="balance.hash"></td>
                <td class="truncate pr-6 py-2 pl-6 md:pl-0" x-html="Wrap.amount(balance.amount, balance.token, balance.tokenPreview)"></td>
                <td class="truncate pr-4 py-2" x-html="Wrap.token(balance.token)"></td>
            </tr>
        </template>
    </tbody>
</table>


<!-- <table class="w-full table-fixed font-light text-sm">
    <thead>
        <tr class="text-gray-400">
            <th class="truncate py-2 pr-4 text-left uppercase w-1/2 md:w-4/12 pl-6">Amount</th>
            <th class="truncate py-2 pr-6 md:pr-4 text-left uppercase w-1/2 md:w-5/12">Token</th>
            <th class="truncate py-2 pr-6 text-left uppercase md:w-4/12 hidden md:table-cell">Hash</th>
        </tr>
    </thead>
    <tbody>
        <template x-for="(balance, i) in balances">
            <tr :class="{'bg-gray-900 bg-opacity-50': i % 2 == 0}" class="hover:bg-gray-900 text-white">
                <td class="truncate pr-4 py-2 pl-6" x-html="Wrap.amount(balance.amount, balance.token, balance.tokenPreview)"></td>
                <td class="truncate pr-6 md:pr-4 py-2" x-html="Wrap.token(balance.token)"></td>
                <td class="truncate pr-6 py-2 hidden md:table-cell" x-html="balance.hash"></td>
            </tr>
        </template>
    </tbody>
</table> --></div>
        <div x-cloak x-show="resource == 'transactions'"><table class="w-full table-fixed font-light text-sm">
    <thead>
        <tr class="text-gray-400">
            <th class="truncate py-2 pr-4 text-left uppercase w-1/3 md:w-5/12 pl-6">Hash</th>
            <th class="truncate py-2 pr-4 text-left uppercase w-1/3 md:w-5/12">Sender</th>
            <th class="truncate py-2 pr-6 text-left uppercase w-1/3 md:w-2/12">Created</th>
        </tr>
    </thead>
    <tbody>
        <template x-for="(transaction, i) in transactions">
            <tr :class="{'bg-gray-900 bg-opacity-50': i % 2 == 0}" class="hover:bg-gray-900 text-white">
                <td class="truncate pr-4 py-2 pl-6" x-html="Wrap.transaction(transaction.hash)"></td>
                <td class="truncate pr-4 py-2" x-html="Wrap.address(transaction.sender)"></td>
                <td class="truncate pr-6 py-2" x-text="formatTime(transaction.created)"></td>
            </tr>
        </template>
    </tbody>
</table></div>
        <div x-cloak x-show="resource == 'pools'"><table class="w-full table-fixed font-light text-sm">
    <thead>
        <tr class="text-gray-400">
            <th class="truncate py-2 pr-4 text-left uppercase w-2/5 md:w-4/12 pl-6">Address</th>
            <th class="truncate py-2 pr-4 text-left uppercase w-0 md:w-3/12 hidden md:table-cell">Name</th>
            <th class="truncate py-2 pr-4 text-left uppercase w-2/5 md:w-2/12">TokenBalance</th>
            <th class="truncate py-2 pr-6 md:pr-4 text-left uppercase w-1/5 md:w-1/12">Program</th>
            <th class="truncate py-2 pr-6 text-left uppercase w-0 md:w-2/12 hidden md:table-cell">Expires</th>
        </tr>
    </thead>
    <tbody>
        <template x-for="(pool, i) in pools">
            <tr :class="{'bg-gray-900 bg-opacity-50': i % 2 == 0}" class="hover:bg-gray-900 text-white">
                <td class="truncate pr-4 py-2 pl-6" x-html="Wrap.pool(pool.address)"></td>
                <td class="truncate pr-4 py-2 hidden md:table-cell" x-html="pool.name ? pool.name : 'Unnamed'"></td>
                <td class="truncate pr-4 py-2" x-html="Wrap.amount(pool.tokenBalance, pool.token, pool.tokenPreview)"></td>
                <td class="truncate pr-6 md:pr-4 py-2" x-html="pool.program.toUpperCase()"></td>
                <td class="truncate pr-6 py-2 hidden md:table-cell" x-text="pool.expires ? formatTime(pool.expires) : 'Never'"></td>
            </tr>
        </template>
    </tbody>
</table></div>
        

        <div x-show="!depleted[resourceFilter]" class="pt-6 flex justify-center text-sm">
            <span @click="load(resource)" class="cursor-pointer underline w-full text-center text-sm text-gray-100 py-2 hover:bg-gray-900 rounded">Load more</span>
        </div>
    </div>    
</div>