<script>
function poolExplorer() {
    return {
        tab: 'transfersIn',
        transfersIn: [],
        transfersOut: [],
        transfers: [], // Filtered transfers
        claims: [],
        transfersFilter: 'in', // in, out
        claimsFilter: 'issued', // issued, held
        existing: [],
        address: gup('address'),
        depleted: {},
        init() {
            this.loadTransfers()
        },
        loadTransfers() {
            if (this.transfersFilter == 'in') this.loadTransfersIn()
            else if (this.transfersFilter == 'out') this.loadTransfersOut()
        },
        // loadTransfersOut() {
        //     this.transfers = this.transfersOut
        //     if (this.depleted.transfersOut) return
        //     var last = this.transfersOut.length ? {hash: this.transfersOut.slice(-1)[0].hash, created: this.transfersOut.slice(-1)[0].created} : {}
    
        //     var self = this
        //     Xeta.transfer.scanFromCreated({from: this.address, created: last.created, hash: last.hash}, {preview: true}).then(function(data) {
        //         if (!data.length) self.depleted.transfersOut = true
        //         self.transfersOut = self.transfersOut.concat(data)
        //         self.transfers = self.transfersOut
        //     }).catch(function(e) {})
        // },
        // loadTransfersIn() {
        //     this.transfers = this.transfersIn
        //     if (this.depleted.transfersIn) return
        //     var last = this.transfersIn.length ? {hash: this.transfersIn.slice(-1)[0].hash, created: this.transfersIn.slice(-1)[0].created} : {}
    
        //     var self = this
        //     Xeta.transfer.scanToCreated({to: this.address, created: last.created, hash: last.hash}, {preview: true}).then(function(data) {
        //         if (!data.length) self.depleted.transfersIn = true
        //         self.transfersIn = self.transfersIn.concat(data)
        //         self.transfers = self.transfersIn
        //     }).catch(function(e) {})
        // },
        // loadClaims() {
        //     if (this.depleted.claims) return
        //     var last = this.claims.length ? {hash: this.claims.slice(-1)[0].hash, created: this.claims.slice(-1)[0].created} : {}
    
        //     var self = this
        //     Xeta.claim.scanIssuerCreated({issuer: this.address, created: last.created, hash: last.hash}, {preview: true}).then(function(data) {
        //         if (!data.length) self.depleted.claims = true
        //         self.claims = self.claims.concat(data)
        //     }).catch(function(e) {})
        // },
    }
}
</script>

<div x-data="poolExplorer()">
    <div class="bg-black rounded-2xl px-2 pt-2 mb-2 text-sm font-light text-gray-200 section">
        <div class="flex flex-wrap">
            <div @click="tab = 'transfersIn', loadTransfers()" :class="{'border-pink-700': tab == 'transfersIn' || tab == 'transfersOut'}" class="inline border-b-4 border-gray-900 hover:border-pink-700 px-4 py-2 cursor-pointer">Transfers</div>
            <div @click="tab = 'claims', loadClaims()" :class="{'border-pink-700': tab == 'claims'}" class="inline border-b-4 border-gray-900 hover:border-pink-700 px-4 py-2 cursor-pointer">Claims</div>
        </div>
    </div>

    <div x-cloak x-show="tab == 'transfersIn' || tab == 'transationsOut'" class="bg-black rounded-2xl py-4 mb-4 lg:mb-12">
        <div class="flex justify-between items-center px-6">
            <p class="text-lg py-2 text-gray-100">Transactions</p>
            <div x-data="{active: false}" class="relative text-white text-sm">
                <span @click="active = !active" class="select-none cursor-pointer px-3 py-2 rounded-2xl text-gray-200 hover:bg-gray-800 bg-gray-900" x-text="{'in': 'Incoming', 'out': 'Outgoing'}[transfersFilter]"></span>
                <div x-cloak x-show="active" @click.away="active = false" class="absolute right-0 origin-top-right mt-2 w-32 shadow-xl rounded z-50">
                    <ul class="list-none bg-gray-900 px-2 py-2 rounded-2xl">
                        <li @click="transfersFilter = 'in', loadTransfers(), active = false" class="cursor-pointer py-1 rounded-2xl text-gray-200 hover:bg-gray-800 text-center">Incoming</li>
                        <li @click="transfersFilter = 'out', loadTransfers(), active = false" class="cursor-pointer py-1 rounded-2xl text-gray-200 hover:bg-gray-800 text-center">Outgoing</li>
                    </ul>
                </div>
            </div>
        </div>

        
        <table class="w-full table-fixed font-light text-sm">
    <thead>
        <tr class="text-gray-400">
            <th class="truncate py-2 pr-4 text-left uppercase w-2/12 pl-6">Hash</th>
            <th class="truncate py-2 pr-4 text-left uppercase w-2/12">Amount</th>
            <th class="truncate py-2 pr-4 text-left uppercase w-3/12">From</th>
            <th class="truncate py-2 pr-4 text-left uppercase w-3/12">To</th>
            <th class="truncate py-2 pr-4 text-right uppercase w-2/12">Created</th>
        </tr>
    </thead>
    <tbody>
        <template x-for="(transfer, i) in transfers">
            <tr :class="{'bg-gray-900 bg-opacity-50': i % 2 == 0}" class="hover:bg-gray-900 text-white">
                <td class="truncate pr-4 py-2 pl-6" x-html="Wrap.transfer(transfer.hash)"></td>
                <td class="truncate pr-4 py-2" x-html="Wrap.amount(transfer.amount, transfer.token, transfer.tokenPreview)"></td>
                <td class="truncate pr-4 py-2" x-html="Wrap.address(transfer.from)"></td>
                <td class="truncate pr-4 py-2" x-html="Wrap.address(transfer.to)"></td>
                <td class="truncate pr-4 py-2 text-right" x-text="formatTime(transfer.created)"></td>
            </tr>
        </template>
    </tbody>
</table>

        <div x-show="(transfersFilter == 'in' && !depleted.transfersIn) || (transfersFilter == 'out' && !depleted.transfersOut)" class="pt-6 flex justify-center text-sm">
            <span @click="loadTransfers()" class="cursor-pointer underline w-full text-center text-sm text-gray-100 py-2 hover:bg-gray-900 rounded">Load more</span>
        </div>
    </div>

    <div x-cloak x-show="tab == 'claims'" class="bg-black rounded-2xl py-4 mb-4 lg:mb-12">
        <p class="text-lg py-2 px-6 text-gray-100">Claims</p>

        <table class="w-full table-fixed font-light text-sm">
    <thead>
        <tr class="text-gray-400">
            <th class="truncate py-2 pl-6 pr-4 text-left uppercase w-1/3 md:w-1/5">
                Hash
            </th>
            <th class="hidden md:table-cell truncate py-2 pr-4 text-left uppercase w-1/4 md:w-1/6">
                Owner
            </th>
            <th class="hidden md:table-cell truncate truncate py-2 pr-4 text-left uppercase w-1/6">
                Address
            </th>
            <th class="hidden md:table-cell truncate py-2 pr-4 text-left uppercase w-1/6">
                Value
            </th>
            <th class="truncate py-2 pr-4 text-left uppercase w-1/4 md:w-1/6">
                Unlocks
            </th>
            <th class="truncate py-2 pr-4 text-left uppercase w-1/4 md:w-1/6">
                Answer
            </th>
            <th class="truncate py-2 pr-6 text-left uppercase w-1/4 md:w-1/6">
                Created
            </th>
        </tr>
    </thead>
    <tbody>
        <template x-for="(claim, i) in claims">
            <tr :class="{'bg-gray-900 bg-opacity-50': i % 2 == 0}" class="hover:bg-gray-900 text-white">
                <td class="truncate pr-4 pl-6 py-2">
                    <a x-text="claim.hash" :href="'/claim/?hash='+claim.hash" class="underline hover:text-pink-400"></a>
                </td>                     
                <td class="truncate pr-4 py-2">
                    <a x-text="claim.owner" :href="'/address/?address='+claim.owner" class="underline hover:text-pink-400"></a>
                </td>
                <td class="truncate pr-4 py-2">
                    <a x-text="claim.address" :href="'/address/?address='+claim.address" class="underline hover:text-pink-400"></a>
                </td>
                <td class="truncate pr-4 py-2">
                    <a :href="'/token/?address='+claim.token" x-html="claim.amount.toString()+(claim.tokenPreview ? (claim.tokenPreview.ticker ? ' '+claim.tokenPreview.ticker : '') : '')" class="hover:text-pink-400"></a>
                </td>
                <td class="truncate pr-4 py-2">
                    <span x-text="formatTime(claim.unlocks)"></span>
                </td>
                <td class="truncate pr-4 py-2">
                    <span x-cloak x-show="claim.answer" x-text="claim.answer"></span>
                    <span x-cloak x-show="claim.number" x-text="claim.number"></span>
                </td>
                <td x-text="formatTime(claim.created)" class="truncate pr-6 py-2">
                </td>
            </tr>
        </template>
    </tbody>
</table>

        <div x-show="!depleted.claims" class="pt-6 flex justify-center text-sm">
            <span @click="loadClaims()" class="cursor-pointer underline w-full text-center text-sm text-gray-100 py-2 hover:bg-gray-900 rounded">Load more</span>
        </div>
    </div>
</div>