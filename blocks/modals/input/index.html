<script>
function inputModal() {
    return {
        optional: false,
        transacting: false,
        data: {},
        inputs: {},
        values: {},
        init() {},
        submit() {
            var self = this
            if (!this.transacting) {
                this.transacting = true
                this.data.pool[this.data.function](this.values).then(tx => {
                    window.location.href = '/transaction/?signature='+tx.signature
                }).catch(e => {
                    self.transacting = false
                    alert(e)
                })
            }
        }
    }
}
</script>

<div x-cloak name="inputModal" id="input-modal" x-show.transition.opacity="$store.modal == 'inputModal'" x-data="inputModal" class="z-50 fixed w-full h-full top-0 left-0">
    <div @click="hideModal()" class="backdrop absolute w-full h-full bg-black opacity-75 z-0"></div>

    <div @click="hideModal()" class="relative cursor-pointer flex w-full justify-center py-4 text-white text-sm z-50">
        <svg class="fill-current text-white mt-0.5" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18">
            <path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path>
        </svg>
        <span class="ml-1">Close</span>
    </div>

    <div class="overflow-scroll max-h-full mx-auto w-full md:w-1/2 pb-32 z-50 relative">
        <div class="rounded-2xl shadow w-full relative bg-pink-900 px-2 lg:px-8 py-4 bg-top bg-cover" style="background-image: url(/media/background.jpg)">
            <p class="w-full px-4 pb-4 text-2xl text-center text-white" x-text="data.title"></p>
            <p class="w-full px-4 pb-4 text-sm text-center text-white" x-text="data.description"></p>

            <div x-cloak x-show="transacting" class="flex justify-center">
                <div class="spinner"></div>
            </div>

            <form x-cloak x-show="!transacting" x-data>
                <template x-for="[key, data] in Object.entries(inputs)">
                    <div>
                        <div x-cloak x-show="(data.required || optional) && ['number', 'integer', 'timestamp', 'hash', 'string'].includes(data.type)" class="mb-6">
                            <label class="text-gray-200 text-xs font-semibold uppercase mb-2 block" x-text="key+(data.required ? ' (required)' : '')"></label>
                            <input x-model="values[key]" :data-rules="JSON.stringify([].concat(data.required ? 'required' : 'optional').concat('maxLength:256').concat(data.type == 'timestamp' ? ['minLength:13', 'maxLength:13']: []).concat(data.type == 'hash' ? ['minLength:32', 'maxLength:44'] : []))"  @input="validate($el)" @blur="validate($el)" :type="['hash', 'string'].includes(data.type) ? 'text' : 'number'" class="rounded-2xl shadow border-pink-700 focus:border-pink-500 border-2 transition-all px-4 py-2 bg-transparent text-gray-100 outline-none focus:outline-none overflow-hidden w-full" />
                            <p class="text-gray-200 text-xs mt-2 hidden"></p>
                        </div>

                        <div x-cloak x-show="(data.required || optional) && ['text', 'strings', 'hashes'].includes(data.type)" class="mb-6 w-full">
                            <label class="text-gray-200 text-xs font-semibold uppercase mb-2 block" x-text="key+(data.required ? ' (required)' : '')"></label>
                            <textarea x-model="values[key]" :data-rules="JSON.stringify([].concat(data.required ? 'required' : []).concat('maxLength:8192'))" @input="validate($el)" @blur="validate($el)" type="text" rows="3" class="rounded-2xl shadow border-pink-700 focus:border-pink-500 border-2 transition-all px-4 py-2 bg-transparent text-gray-100 font-light outline-none focus:outline-none overflow-hidden w-full"></textarea>
                            <p class="text-gray-200 text-xs mt-2 hidden"></p>
                        </div>

                        <div x-cloak x-show="(data.required || optional) && ['boolean'].includes(data.type)" class="mb-6">
                            <label class="text-gray-200 text-xs font-semibold uppercase mb-2 block cursor-pointer items-center flex select-none">
                                <input :checked="values[key]" x-model="values[key]" type="checkbox" class="mr-2 h-6 w-6">
                                <span x-text="key+(data.required ? ' (required)' : '')"></span>
                            </label>
                        </div>
                    </div>
                </template>

                <label x-cloak x-show="Object.values(inputs).some(function(i) {return !i.required})" @click="optional = !optional" class="cursor-pointer text-gray-200 text-xs font-semibold uppercase mb-2 block underline mb-4"><span x-text="optional ? 'Hide' : 'Show'"></span> Optional Fields</label>
                
                <div>
                    <button @click.prevent="validForm($root) ? submit() : ''" type="submit" class="cursor-pointer text-white py-2 px-4 rounded-2xl block text-center bg-black hover:bg-gray-800 transition-all w-full">Submit Transaction</button>
                </div>
            </form>
        </div>
    </div>
</div>