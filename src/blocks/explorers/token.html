<script>
function tokenExplorer() {
    return {
        tab: 'transactions',
        transactions: [],
        holders: [],
        address: gup('address'),
        depleted: {},
        init() {
            this.loadTransactions()
        },
        loadTransactions() {
            if (this.depleted.transactions) return
            var self = this
            var last = this.transactions.length ? '&signature='+this.transactions.slice(-1)[0].signature+'&created='+this.transactions.slice(-1)[0].created : ''
            ajax(INTERFACE+'/transactions?token='+this.address+'&extended=1&sort=DESC'+last, null, function(data) {
                data = JSON.parse(data)
                if (!data.length) self.depleted.transactions = true
                self.transactions = self.transactions.concat(data)
            })
        },
        loadHolders() {
            if (this.depleted.holders) return
            var self = this
            var last = this.holders.length ? '&address='+this.holders.slice(-1)[0].address+'&amount='+this.holders.slice(-1)[0].amount : ''
            ajax(INTERFACE+'/balances?token='+this.address+'&extended=1&sort=DESC'+last, null, function(data) {
                data = JSON.parse(data)
                if (!data.length) self.depleted.holders = true
                self.holders = self.holders.concat(data)
            })
        },
    }
}
</script>

<div x-data="tokenExplorer">
    <div class="bg-black rounded-2xl px-2 pt-2 mb-2 font-light text-gray-200 section">
        <div class="flex flex-wrap">
            <div @click="tab = 'transactions', !transactions.length ? loadTransactions() : ''" :class="{'border-pink-700': tab == 'transactions'}" class="inline border-b-4 border-gray-900 hover:border-pink-700 px-4 py-2 cursor-pointer">transactions</div>
            <div @click="tab = 'holders', !holders.length ? loadHolders() : ''" :class="{'border-pink-700': tab == 'holders'}" class="inline border-b-4 border-gray-900 hover:border-pink-700 px-4 py-2 cursor-pointer">Holders</div>
        </div>
    </div>

    <div x-cloak x-show="tab == 'transactions'" class="bg-black rounded-2xl py-4 mb-4 lg:mb-12">
        <p class="text-lg py-2 px-6 text-gray-100">transactions</p>

        {% set transactionsCollection = 'transactions' %}
        {% include "src/blocks/lists/transactions.html" %}
        
        <div x-show="!depleted.transactions" class="pt-6 flex justify-center text-sm">
            <span @click="loadTransactions()" class="cursor-pointer underline w-full text-center text-sm text-gray-100 py-2 hover:bg-gray-900 rounded">Load more</span>
        </div>
    </div>
    
    <div x-cloak x-show="tab == 'holders'" class="bg-black rounded-2xl px-6 py-4 mb-4 lg:mb-12">
        <p class="text-lg py-2 px-6 text-gray-100">Holder Distribution</p>

        <table class="w-full table-fixed">
            <thead>
                <tr>
                    <th class="py-2 text-gray-400 text-left uppercase text-sm w-1/3">
                        Address
                    </th>
                    <th class="py-2 text-gray-400 text-left uppercase text-sm w-1/3">
                        Amount
                    </th>
                    <th class="py-2 text-gray-400 text-right uppercase text-sm w-1/3 md:w-1/4">
                        Percent
                    </th>
                </tr>
            </thead>
            <tbody>
                <template x-for="balance in holders">
                    <tr>
                        <td class="truncate pr-4 py-2">
                            <a :href="'/address/?address='+balance.address" x-text="balance.address" class="underline hover:text-pink-400"></a>
                        </td>
                        <td x-text="balance.amount+(balance.tokenPreview.symbol ? ' '+balance.tokenPreview.symbol : '')" class="truncate py-2">
                        </td>
                        <td x-text="$store.token ? (balance.amount/$store.token.supply*100).toFixed(2)+'%' : 0+'%'" class="truncate py-2 text-right">
                        </td>
                    </tr>
                </template>
            </tbody>
        </table>

        <div x-show="!depleted.holders" class="pt-6 flex justify-center text-sm">
            <span @click="loadHolders()" class="cursor-pointer underline w-full text-center text-sm text-gray-100 py-2 hover:bg-gray-900 rounded">Load more</span>
        </div>
    </div>
</div>