<script>
function inputModal() {
    return {
        transacting: false,
        inputs: [],
        title: null,
        description: null,
        function: null,
        fts: {},
        nfts: {},
        tokens: {},
        claims: {},
        addresses: {},
        programs: {
            auction: 'Auction',
            launch: 'Launch',
            lending: 'Lending',
            lock: 'Lock',
            loot: 'Loot',
            lottery: 'Lottery',
            royalty: 'Royalty',
            staking: 'Staking',
            vote: 'Vote',
        },
        loaded: {},
        values: {},
        init() {
            var self = this
            this.inputs.forEach(function(input) {
                if (self.values[input.name] == null) {
                    if (input.value) self.values[input.name] = Alpine.store(input.value.split('.')[0])[input.value.split('.')[1]]
                    else self.values[input.name] = null
                }
            })

            // Init token, claim and address suggestions
            if (Xeta.config.publicKey) {
                var suggest = this.inputs.map(function(i) {return i.suggest})
                if (!this.loaded.tokens && (suggest.includes('fts') || suggest.includes('tokens'))) {
                    this.fts = {
                        '11111111111111111111111111111xeta': 'Xeta (XETA): 0',
                        '11111111111111111111111111111xusd': 'Xeta USD (XUSD): 0',
                        '1111111111111111111111111sponsored': 'Xeta Sponsored (XS): 0',
                    }

                    Xeta.balance.scanAddressAmount({address: Xeta.config.publicKey}, {limit: 100, preview: true}).then(function(data) {
                        data.forEach(function(d) {
                            if (d.amount != '0') {
                                self.fts[d.token] = [d.tokenPreview.name, '('+d.tokenPreview.symbol+'):', d.amount].join(' ')
                            }
                        })
                        self.tokens = Object.assign({}, self.fts, self.nfts)
                    }).catch(function(e) {throw e})
                    this.loaded.tokens = true
                }

                if (!this.loaded.nfts && (suggest.includes('nfts') || suggest.includes('tokens'))) {
                    Xeta.token.scanOwnerCreated({owner: Xeta.config.publicKey}, {limit: 100}).then(function(data) {
                        data.forEach(function(d) { self.nfts[d.address] = d.name })
                        self.tokens = Object.assign({}, self.fts, self.nfts)
                    }).catch(function(e) {throw e})
                }

                if (!this.loaded.addresses && suggest.includes('addresses')) {
                    this.addresses = {[Xeta.config.publicKey]: 'Connected Wallet: '+Xeta.config.publicKey}

                    Xeta.transfer.scanFromCreated({from: Xeta.config.publicKey}, {limit: 100}).then(function(data) {
                        data.forEach(function(d) { self.addresses[d.to] = d.to })
                    }).catch(function(e) {throw e})
                }

                // Reset claims with every new input
                if (suggest.includes('claims')) {
                    self.claims = {}
                    if (Alpine.store('resource') == 'pools') {
                        Xeta.claim.scanIssuerHolder({issuer: gup('address'), holder: Xeta.config.publicKey}, {limit: 100}).then(function(data) {
                            data.forEach(function(d) { self.claims[d.hash] = [d.hash.slice(0, 10)+'..', d.tokenAmount ? d.tokenAmount+' Tokens' : d.xetaAmount ? d.xetaAmount+' XETA' : '', d.unlocks ? 'Unlocks: '+new Date(d.unlocks).toLocaleDateString() : ''].join(' ') })
                        }).catch(function(e) {throw e})
                    } else {
                        Xeta.claim.scanHolderCreated({holder: Xeta.config.publicKey}, {limit: 100}).then(function(data) {
                            data.forEach(function(d) { self.claims[d.hash] = [d.hash.slice(0, 10)+'..', d.tokenAmount ? d.tokenAmount+' Tokens' : d.xetaAmount ? d.xetaAmount+' XETA' : '', d.unlocks ? 'Unlocks: '+new Date(d.unlocks).toLocaleDateString() : ''].join(' ') })
                        }).catch(function(e) {throw e})
                    }
                }
            }
        },
        /**
         * Parse inputs into target datatype
         */
        data() {
            var datatypes = Object.fromEntries(this.inputs.map(function(i) {
                return [i.name, i.type]
            }))

            var parsed = {}
            Object.entries(this.values).forEach(function(e) {
                var v = typeof e[1] == 'string' ? e[1].trim() : e[1]
                if (v == null || v == '') return

                if (datatypes[e[0]] == 'string') v = String(v)
                else if (datatypes[e[0]] == 'strings') v = v.split(String.fromCharCode(10))
                else if (datatypes[e[0]] == 'number') v = parseFloat(v)
                else if (datatypes[e[0]] == 'numbers') v = v.split(String.fromCharCode(10)).map(function(i) {return parseFloat(i)})
                else if (datatypes[e[0]] == 'hash') v = String(v)
                else if (datatypes[e[0]] == 'hashes') v = v.split(String.fromCharCode(10))
                else if (datatypes[e[0]] == 'text') v = String(v)
                else if (datatypes[e[0]] == 'integer') v = parseInt(v)
                else if (datatypes[e[0]] == 'timestamp') v = parseInt(v)
                else if (datatypes[e[0]] == 'amount') v = String(v)
                else if (datatypes[e[0]] == 'boolean') v = !!v
                else if (datatypes[e[0]] == 'object') v = JSON.parse(v)
                else v = String(v)

                parsed[e[0]] = v
            })

            return parsed
        },
        submit() {  
            if (this.transacting) return
            if (!Xeta.config.privateKey) {
                alert('Please (re)connect your wallet.')
                return
            }

            var self = this
            this.transacting = true
            Xeta.instruction.wrap(Object.assign({}, {function: this.function}, this.data())).then(function(tx) {
                if (['address.update', 'token.update', 'claim.update', 'claim.resolve'].includes(self.function)) window.location.reload()
                else window.location.href = '/transaction/?hash='+tx.hash
            }).catch(function(e) {
                console.log(e.message)
                self.transacting = false
                alert(e)
            })
        }
    }
}
</script>

<div x-cloak name="inputModal" id="input-modal" x-show.transition.opacity="$store.modal == 'inputModal'" x-data="inputModal" class="z-50 fixed w-full h-full top-0 left-0">
    <div @click="hideModal()" class="backdrop absolute w-full h-full bg-black opacity-75 z-0"></div>

    <div @click="hideModal()" class="relative cursor-pointer flex w-full justify-center py-4 text-white text-sm z-50">
        <svg class="fill-current text-white mt-0.5" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18">
            <path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path>
        </svg>
        <span class="ml-1">Close</span>
    </div>

    <div class="overflow-scroll max-h-full mx-auto w-full md:w-1/2 pb-32 z-50 relative">
        <div class="rounded-2xl shadow w-full relative bg-pink-900 px-2 lg:px-8 py-4 bg-top bg-cover" style="background-image: url(/media/background.jpg)">
            <p class="w-full px-4 pb-4 text-2xl text-center text-white" x-text="title"></p>
            <p class="w-full px-4 pb-4 text-sm text-center text-white" x-text="description"></p>

            <div x-cloak x-show="transacting" class="flex justify-center">
                <div class="spinner"></div>
            </div>

            <form x-cloak x-show="!transacting" x-data>
                <template x-for="input in inputs">
                    <div class="mb-6 w-full">
                        <label class="text-gray-200 text-xs font-semibold uppercase mb-2 block" x-text="input.name+(input.required ? ' (required)' : '')"></label>

                        <template x-if="['hash', 'string'].includes(input.type)">
                            <div class="relative">
                                <input
                                    x-model="values[input.name]"
                                    :data-rules="JSON.stringify(['maxLength:256']
                                        .concat(input.required ? 'required' : 'optional')
                                        .concat(input.type == 'hash' ? ['minLength:32', 'maxLength:44'] : []))"
                                    @input="validate($el)"
                                    @blur="validate($el)"
                                    type="text"
                                    class="rounded-2xl shadow border-pink-300 border-opacity-50 focus:border-pink-400 border-2 transition-all px-4 py-2 bg-transparent text-gray-100 outline-none focus:outline-none overflow-hidden w-full focus:ring focus:ring-purple-500"
                                />
                                <p class="text-gray-200 text-xs mt-2 hidden"></p>

                                <div x-show="input.suggest" class="absolute right-0 top-0 px-5 py-2.5">
                                    <span class="text-white">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="" viewBox="0 0 16 16">
                                          <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                                        </svg>
                                    </span>
                                    <select x-model="values[input.name]" class="opacity-0 absolute top-0 left-0 w-full h-full no-arrow py-1 cursor-pointer text-gray-600 outline-none focus:outline-none">
                                        <option value="" selected>Custom</option>
                                        <template x-for="[k, v] in (input.suggest ? Object.entries($data[input.suggest]) : [])">
                                            <option :value="k" x-text="v"></option>
                                        </template>
                                    </select>
                                </div>
                            </div>
                        </template>

                        <template x-if="['integer', 'timestamp'].includes(input.type)">
                            <div>
                                <input
                                    x-model="values[input.name]"
                                    :data-rules="JSON.stringify(['min:0']
                                        .concat(input.required ? 'required' : 'optional')
                                        .concat(input.type == 'timestamp' ? ['minLength:13', 'maxLength:13']: []))"
                                    @input="validate($el)"
                                    @blur="validate($el)"
                                    type="number"
                                    class="rounded-2xl shadow border-pink-300 border-opacity-50 focus:border-pink-400 border-2 transition-all px-4 py-2 bg-transparent text-gray-100 outline-none focus:outline-none overflow-hidden w-full focus:ring focus:ring-purple-500"
                                />
                                <p class="text-gray-200 text-xs mt-2 hidden"></p>
                            </div>
                        </template>

                        <template x-if="['number', 'amount'].includes(input.type)">
                            <div>
                                <input
                                    x-model="values[input.name]"
                                    :data-rules="JSON.stringify(['min:0']
                                        .concat(input.required ? 'required' : 'optional'))"
                                    @input="validate($el)"
                                    @blur="validate($el)"
                                    type="number"
                                    class="rounded-2xl shadow border-pink-300 border-opacity-50 focus:border-pink-400 border-2 transition-all px-4 py-2 bg-transparent text-gray-100 outline-none focus:outline-none overflow-hidden w-full focus:ring focus:ring-purple-500"
                                />
                                <p class="text-gray-200 text-xs mt-2 hidden"></p>
                            </div>
                        </template>

                        <template x-if="['text', 'object', 'strings', 'hashes', 'numbers'].includes(input.type)">
                            <div>
                                <span x-cloak x-show="['strings', 'hashes', 'numbers'].includes(input.type)" class="text-gray-200 text-xs capitalize mb-2 block">One per line</span>
                                <textarea
                                    x-model="values[input.name]"
                                    :data-rules="JSON.stringify(['maxLength:8192']
                                        .concat(input.type == 'object' ? 'json' : [])
                                        .concat(input.required ? 'required' : []))"
                                    @input="validate($el)"
                                    @blur="validate($el)"
                                    type="text"
                                    rows="3"
                                    class="rounded-2xl shadow border-pink-300 border-opacity-50 focus:border-pink-400 border-2 transition-all px-4 py-2 bg-transparent text-gray-100 font-light outline-none focus:outline-none overflow-hidden w-full focus:ring focus:ring-purple-500"
                                ></textarea>
                                <p class="text-gray-200 text-xs mt-2 hidden"></p>
                            </div>
                        </template>

                        <template x-if="['boolean'].includes(input.type)">
                            <div>
                                <label class="text-gray-200 text-xs font-semibold uppercase mb-2 block cursor-pointer items-center flex select-none">
                                    <input :checked="values[input.name]" x-model="values[input.name]" type="checkbox" class="mr-2 h-6 w-6">
                                    <span>Yes</span>
                                </label>
                            </div>
                        </template>
                    </div>
                </template>

                <div>
                    <button @click.prevent="validForm($root) ? submit() : ''" type="submit" class="cursor-pointer text-white py-2 px-4 rounded-2xl block text-center bg-black hover:bg-gray-800 transition-all w-full focus:ring focus:ring-purple-500">Submit</button>
                </div>
            </form>
        </div>
    </div>
</div>