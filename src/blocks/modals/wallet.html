<script>
function walletModal() {
    return {
        selection: null,
        seed: '',
        password: '',
        publicKey: '',
        privateKey: '',
        creating: false,
        init() {
            // showModal('walletModal')
        },
        async generateKeys() {
            this.selection = 'generate'
            var keys = await keypair()
            this.publicKey = keys[0]
            this.privateKey = keys[1]
        },
        async createCredentials() {
            if (!this.creating) {
                var self = this;
                var password = await hashString(this.password)
                var data = {seed: this.seed, password: password}
                Alpine.lstore('seed', this.seed)
                this.creating = true;

                ajax(API+'/credentials', data, function(data) {
                    data = JSON.parse(data)
                    self.selection = 'public'
                    self.publicKey = data.public
                    connectWallet(data.public)
                    self.creating = false;
                }, function(status) {
                    self.creating = false;
                    alert('Something went wrong, please try again (username likely taken)')
                })
            }
        },
        async loadCredentials() {
            var self = this;
            var password = await hashString(this.password)
            Alpine.lstore('seed', this.seed)

            ajax(API+'/credentials?seed='+this.seed+'&password='+password, null, function(data) {
                data = JSON.parse(data)
                self.selection = 'public'
                self.publicKey = data.public
                connectWallet(data.public)
            }, function(status) {
                alert('Something went wrong, please try again (incorrect credentials?)')
            })
        }
    }
}
</script>
<div x-cloak name="walletModal" id="wallet-modal" x-show.transition.opacity="$store.modal == 'walletModal'" x-data="walletModal" class="z-50 fixed w-full h-full top-0 left-0">
    <div @click="hideModal()" class="backdrop absolute w-full h-full bg-black opacity-75"></div>

    <div @click="hideModal()" class="relative cursor-pointer flex w-full justify-center py-4 text-white text-sm z-50">
        <svg class="fill-current text-white mt-0.5" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18">
            <path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path>
        </svg>
        <span class="ml-1">Close</span>
    </div>

    <div class="overflow-scroll h-full mx-auto w-full md:w-1/2 pb-32">
        <div class="rounded-2xl shadow w-full relative bg-pink-900 px-2 lg:px-8 py-4 bg-top bg-cover" style="background-image: url(/media/background.jpg)">
            <div x-show="!selection" class="flex flex-wrap px-2 lg:px-8 text-white font-light">
                <p class="w-full px-4 py-4 text-2xl text-center">Create New Wallet</p>

                <div class="w-1/2 mb-4">
                    <div @click="await generateKeys()" class="mx-4 cursor-pointer rounded-2xl bg-gray-900 bg-opacity-40 hover:bg-black shadow p-4 text-center">
                        <p class="text-lg mb-2">Create new wallet (manage keys yourself)</p>
                        <p class="text-sm">You will receive a public and private key which you need to store securily.</p>
                    </div>
                </div>
                <div class="w-1/2 mb-4">
                    <div @click="selection = 'managed'" class="mx-4 cursor-pointer rounded-2xl bg-gray-900 bg-opacity-40 hover:bg-black shadow p-4 text-center">
                        <p class="text-lg mb-2">Create new wallet (managed credentials)</p>
                        <p class="text-sm">Xeta Reality will manage credentials for you, transactions can be signed with these credentials.</p>
                    </div>
                </div>

                <p class="w-full px-4 py-4 text-2xl text-center">Import Existing Wallet</p>

                <div class="w-1/2 mb-4">
                    <div @click="selection = 'import'" class="mx-4 cursor-pointer rounded-2xl bg-gray-900 bg-opacity-40 hover:bg-black shadow p-4 text-center">
                        <p class="text-lg mb-2">Self-managed wallet keys</p>
                        <p class="text-sm">Import wallet via public key. Choose this option if you've created a Xeta private/public key previously.</p>
                    </div>
                </div>
                <div class="w-1/2 mb-4">
                    <div @click="selection = 'credentials'" class="mx-4 cursor-pointer rounded-2xl bg-gray-900 bg-opacity-40 hover:bg-black shadow p-4 text-center">
                        <p class="text-lg mb-2">Managed credentials</p>
                        <p class="text-sm">Log-in using your username and password. Choose this option if you have a managed wallet on Xeta.</p>
                    </div>
                </div>
            </div>

            <div x-show="selection == 'generate'" class="flex flex-wrap w-full px-2 lg:px-8 py-8 text-white font-light">
                <p @click="selection = null" class="cursor-pointer text-gray-200 mb-4 underline">← Go back</p>

                <div class="mb-6 w-full">
                    <label for="" class="text-gray-200 text-sm uppercase mb-2 block">Your public key (public wallet address)</label>
                    <input x-model="publicKey" @focus="$el.select()" type="text" class="rounded-2xl shadow border-pink-700 focus:border-pink-500 border-2 transition-all px-4 py-2 bg-transparent text-gray-100 font-light outline-none focus:outline-none overflow-hidden w-full" />
                </div>
  
                <div class="mb-6 w-full">
                    <label for="" class="text-gray-200 text-sm uppercase mb-2 block">Your private key (keep this secret at any cost!)</label>
                    <input x-model="privateKey" @focus="$el.select()" type="text" class="rounded-2xl shadow border-pink-700 focus:border-pink-500 border-2 transition-all px-4 py-2 bg-transparent text-gray-100 font-light outline-none focus:outline-none overflow-hidden w-full" />
                </div>

                <div class="w-full">
                    <button @click.prevent="selection = null, connectWallet(publicKey), hideModal()" class="cursor-pointer text-white py-2 px-4 rounded-2xl block text-center bg-black hover:bg-gray-900 text-lg font-light transition-all w-full">I've stored my keys securely - connect wallet & close modal</button>
                </div>
            </div>

            <form x-data x-show="selection == 'managed'" class="flex flex-wrap w-full px-2 lg:px-8 py-8 text-white font-light">
                <p @click="selection = null" class="cursor-pointer text-gray-200 mb-4 underline">← Go back</p>

                <div class="mb-6 w-full">
                    <label for="" class="text-gray-200 text-sm uppercase mb-2 block">Email or username</label>
                    <input x-model="seed" data-rules='["required", "minimum:6"]' @input="validate($el)" @blur="validate($el)" type="text" class="rounded-2xl shadow border-pink-700 focus:border-pink-500 border-2 transition-all px-4 py-2 bg-transparent text-gray-100 font-light outline-none focus:outline-none overflow-hidden w-full" />
                    <p class="text-gray-200 text-xs mt-2 hidden"></p>
                </div>

                <div class="mb-6 w-full">
                    <label for="" class="text-gray-200 text-sm uppercase mb-2 block">Your password</label>
                    <input x-model="password" data-rules='["required", "minimum:6"]' @input="validate($el)" @blur="validate($el)" type="password" class="rounded-2xl shadow border-pink-700 focus:border-pink-500 border-2 transition-all px-4 py-2 bg-transparent text-gray-100 font-light outline-none focus:outline-none overflow-hidden w-full" />
                    <p class="text-gray-200 text-xs mt-2 hidden"></p>
                </div>

                <div class="w-full">
                    <button @click.prevent="validForm($root) ? await createCredentials() : ''" type="submit" class="cursor-pointer text-white py-2 px-4 rounded-2xl block text-center bg-black hover:bg-gray-900 text-lg font-light transition-all w-full">Create credentials and show public key</button>
                </div>
            </form>

            <div x-show="selection == 'public'" class="flex flex-wrap w-full px-2 lg:px-8 py-8 text-white font-light">
                <div class="mb-6 w-full">
                    <label for="" class="text-gray-200 text-sm uppercase mb-2 block">Your public key (public wallet address)</label>
                    <input x-model="publicKey" @focus="$el.select()" type="text" class="rounded-2xl shadow border-pink-700 focus:border-pink-500 border-2 transition-all px-4 py-2 bg-transparent text-gray-100 font-light outline-none focus:outline-none overflow-hidden w-full" />
                </div>

                <div class="w-full">
                    <button @click.prevent="selection = null, hideModal()" class="cursor-pointer text-white py-2 px-4 rounded-2xl block text-center bg-black hover:bg-gray-900 text-lg font-light transition-all w-full">I've stored my public key - close this window</button>
                </div>
            </div>

            <div x-show="selection == 'import'" class="flex flex-wrap w-full px-2 lg:px-8 py-8 text-white font-light">
                <p @click="selection = null" class="cursor-pointer text-gray-200 mb-4 underline">← Go back</p>

                <div class="mb-6 w-full">
                    <label for="" class="text-gray-200 text-sm uppercase mb-2 block">Paste your public key (public wallet address)</label>
                    <input x-model="publicKey" type="text" class="rounded-2xl shadow border-pink-700 focus:border-pink-500 border-2 transition-all px-4 py-2 bg-transparent text-gray-100 font-light outline-none focus:outline-none overflow-hidden w-full" />
                </div>

                <div class="w-full">
                    <button @click.prevent="selection = null, connectWallet(publicKey), hideModal()" class="cursor-pointer text-white py-2 px-4 rounded-2xl block text-center bg-black hover:bg-gray-900 text-lg font-light transition-all w-full">Import this public key and close modal</button>
                </div>
            </div>

            <form x-data x-show="selection == 'credentials'" class="flex flex-wrap w-full px-2 lg:px-8 py-8 text-white font-light">
                <p @click="selection = null" class="cursor-pointer text-gray-200 mb-4 underline">← Go back</p>

                <div class="mb-6 w-full">
                    <label for="" class="text-gray-200 text-sm uppercase mb-2 block">Email or username</label>
                    <input x-model="seed" data-rules='["required", "minimum:6"]' @input="validate($el)" @blur="validate($el)" type="text" class="rounded-2xl shadow border-pink-700 focus:border-pink-500 border-2 transition-all px-4 py-2 bg-transparent text-gray-100 font-light outline-none focus:outline-none overflow-hidden w-full" />
                    <p class="text-gray-200 text-xs mt-2 hidden"></p>
                </div>

                <div class="mb-6 w-full">
                    <label for="" class="text-gray-200 text-sm uppercase mb-2 block">Your password</label>
                    <input x-model="password" data-rules='["required", "minimum:6"]' @input="validate($el)" @blur="validate($el)" type="password" class="rounded-2xl shadow border-pink-700 focus:border-pink-500 border-2 transition-all px-4 py-2 bg-transparent text-gray-100 font-light outline-none focus:outline-none overflow-hidden w-full" />
                    <p class="text-gray-200 text-xs mt-2 hidden"></p>
                </div>

                <div class="w-full">
                    <button @click.prevent="validForm($root) ? await loadCredentials() : ''" type="submit" class="cursor-pointer text-white py-2 px-4 rounded-2xl block text-center bg-black hover:bg-gray-900 text-lg font-light transition-all w-full">Initialize wallet</button>
                </div>
            </form>
        </div>
    </div>
</div>